<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi Siswa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .scrollbar-thin {
      scrollbar-width: thin;
    }
    .scrollbar-thin::-webkit-scrollbar {
      height: 6px;
      width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body class="bg-gray-100 p-4 md:p-6 min-h-screen">

<div class="max-w-7xl mx-auto">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800">üìä Dashboard Absensi Siswa</h1>
    <p class="text-gray-600 mt-1">Update alasan tidak masuk per siswa</p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Sidebar Form -->
    <div class="lg:col-span-1 bg-white rounded-xl shadow p-5">
      <div class="mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
          <span class="bg-blue-100 p-2 rounded-lg mr-2">üìù</span>
          Update Alasan
        </h2>
        <p class="text-sm text-gray-500 mb-4">Isi form untuk update ketidakhadiran siswa</p>
      </div>

      <div class="space-y-4">
        <!-- Kelas Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
          <select id="kelasFilter" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            <option value="">-- Pilih Kelas --</option>
          </select>
        </div>

        <!-- Siswa Filter -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Siswa</label>
          <select id="siswaFilter" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            <option value="">-- Pilih Siswa --</option>
          </select>
        </div>

        <!-- Kolom (Tanggal) -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal (Kolom)</label>
          <select id="col" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            <option value="">-- Pilih Tanggal --</option>
          </select>
        </div>

        <!-- Alasan -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Alasan Tidak Masuk</label>
          <input id="value" placeholder="Contoh: Sakit, Izin, dll" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
        </div>

        <!-- Buttons -->
        <div class="flex space-x-3 pt-2">
          <button onclick="updateCell()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
            <span class="mr-2">‚úÖ</span>
            Update Data
          </button>
          <button onclick="resetForm()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-4 rounded-lg transition duration-200">
            Reset
          </button>
        </div>

        <!-- Result Message -->
        <p id="result" class="text-green-600 font-semibold text-sm mt-3 min-h-[24px]"></p>

        <!-- Info -->
        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
          <p class="text-sm text-blue-800 font-medium mb-1">‚ÑπÔ∏è Informasi</p>
          <p class="text-xs text-blue-700">‚Ä¢ Row 1 = Header, Row 2 = Data pertama siswa</p>
          <p class="text-xs text-blue-700">‚Ä¢ Kolom 3-33 = Tanggal 1-31 (bulan berjalan)</p>
          <p class="text-xs text-blue-700">‚Ä¢ Tabel otomatis filter sesuai pilihan</p>
        </div>
      </div>
    </div>

    <!-- Main Content / Tabel -->
    <div class="lg:col-span-3">
      <div class="bg-white rounded-xl shadow p-5 h-full">
        <!-- Tabel Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
          <div>
            <h2 class="text-xl font-bold text-gray-800 mb-1 flex items-center">
              <span class="bg-green-100 p-2 rounded-lg mr-2">üìã</span>
              Data Absensi
            </h2>
            <div class="text-sm text-gray-600">
              <span id="kelasDisplay" class="font-bold text-blue-600">Semua Kelas</span>
              <span id="siswaDisplay" class="ml-2 text-gray-500"></span>
            </div>
          </div>
          <div class="mt-3 sm:mt-0 flex space-x-2">
            <button onclick="toggleView()" id="toggleViewBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium py-2 px-4 rounded-lg transition">
              Tampilkan Semua
            </button>
            <button onclick="loadData()" class="bg-green-100 hover:bg-green-200 text-green-700 text-sm font-medium py-2 px-4 rounded-lg transition flex items-center">
              <span class="mr-2">üîÑ</span>
              Refresh Data
            </button>
          </div>
        </div>

        <!-- Tabel Container -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="overflow-x-auto scrollbar-thin max-h-[500px]">
            <table id="sheetTable" class="min-w-full divide-y divide-gray-200">
              <!-- Tabel akan diisi otomatis -->
            </table>
          </div>
          
          <!-- Empty State -->
          <div id="emptyState" class="hidden p-8 text-center">
            <div class="text-gray-400 text-4xl mb-3">üì≠</div>
            <p class="text-gray-500 font-medium">Tidak ada data untuk ditampilkan</p>
            <p class="text-gray-400 text-sm mt-1">Pilih kelas atau siswa untuk melihat data</p>
          </div>
        </div>

        <!-- Tabel Info Footer -->
        <div class="mt-4 flex flex-wrap justify-between items-center text-xs text-gray-500">
          <div class="flex items-center">
            <div class="w-3 h-3 bg-green-100 rounded mr-2"></div>
            <span>MASUK</span>
            <div class="w-3 h-3 bg-yellow-100 rounded mx-3 ml-4"></div>
            <span>IZIN/SAKIT</span>
            <div class="w-3 h-3 bg-blue-100 rounded mx-3"></div>
            <span>KOSONG</span>
          </div>
          <div id="rowCount" class="mt-2 sm:mt-0">0 data ditampilkan</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyqQOikUdA_eg8KsEGsU5HwPN5U0mNpiQ0EaXS7AWD9oXZ2le0AWZ7IqI5v080bLN6s/exec";

let allData = [];
let currentKelas = "";
let currentSiswa = "";
let showAllData = false;
let rowMapping = {};

// Load data saat awal
window.onload = async function() {
  await loadData();
};

// Load data
async function loadData() {
  try {
    document.getElementById("result").innerText = "Memuat data...";
    
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    
    const data = await res.json();
    console.log("Data loaded:", data);
    
    // Reorder data: pindah nama dan kelas ke depan
    allData = data.map(row => {
      const { kelas, nama, ...rest } = row;
      return { 
        nama, 
        kelas, 
        ...rest,
        _originalData: row // Simpan data asli untuk referensi
      };
    });
    
    // Generate row mapping
    rowMapping = {};
    allData.forEach((item, index) => {
      if (item.nama) {
        rowMapping[item.nama] = index + 2; // Row 1 header, row 2 data pertama
      }
    });
    
    // Update UI
    populateKelasFilter(allData);
    populateKolomFilter();
    
    // Reset view
    showAllData = false;
    document.getElementById("toggleViewBtn").innerText = "Tampilkan Semua";
    
    // Render tabel awal
    renderFilteredTable();
    document.getElementById("result").innerText = "";
    
  } catch(e) {
    console.error("Error loading data:", e);
    document.getElementById("result").innerText = "‚ùå Gagal memuat data";
  }
}

// Populate kelas filter
function populateKelasFilter(data) {
  const kelasSet = new Set();
  data.forEach(item => {
    if (item.kelas && item.kelas !== "-" && item.kelas !== "") {
      kelasSet.add(item.kelas);
    }
  });
  
  const select = document.getElementById("kelasFilter");
  select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
  
  Array.from(kelasSet).sort().forEach(k => {
    const opt = document.createElement("option");
    opt.value = k;
    opt.innerText = k;
    select.appendChild(opt);
  });
}

// Populate kolom filter
function populateKolomFilter() {
  const select = document.getElementById("col");
  select.innerHTML = '<option value="">-- Pilih Tanggal --</option>';
  
  for(let i = 3; i <= 33; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.innerText = `Hari ${i-2} (Kolom ${i})`;
    select.appendChild(opt);
  }
}

// Ketika kelas dipilih
document.getElementById("kelasFilter").onchange = function() {
  currentKelas = this.value;
  const siswaSelect = document.getElementById("siswaFilter");
  siswaSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>';
  currentSiswa = "";
  
  // Update display
  document.getElementById("kelasDisplay").innerText = currentKelas || "Semua Kelas";
  document.getElementById("siswaDisplay").innerText = "";
  
  if(currentKelas) {
    // Filter siswa berdasarkan kelas
    const filteredSiswa = allData.filter(d => d.kelas === currentKelas);
    
    filteredSiswa.forEach(s => {
      const opt = document.createElement("option");
      const rowNum = rowMapping[s.nama] || 0;
      opt.value = rowNum;
      opt.innerText = s.nama;
      opt.dataset.nama = s.nama;
      siswaSelect.appendChild(opt);
    });
  }
  
  renderFilteredTable();
};

// Ketika siswa dipilih
document.getElementById("siswaFilter").onchange = function() {
  const selectedOption = this.options[this.selectedIndex];
  currentSiswa = selectedOption.dataset.nama || "";
  
  // Update display
  document.getElementById("siswaDisplay").innerText = currentSiswa ? `- ${currentSiswa}` : "";
  
  renderFilteredTable();
};

// Toggle view
function toggleView() {
  showAllData = !showAllData;
  document.getElementById("toggleViewBtn").innerText = showAllData ? "Tampilkan Filter" : "Tampilkan Semua";
  renderFilteredTable();
}

// Render tabel berdasarkan filter
function renderFilteredTable() {
  let filteredData = allData;
  
  if (!showAllData) {
    if (currentSiswa) {
      // Tampilkan hanya siswa yang dipilih
      filteredData = allData.filter(d => d.nama === currentSiswa);
    } else if (currentKelas) {
      // Tampilkan semua siswa di kelas yang dipilih
      filteredData = allData.filter(d => d.kelas === currentKelas);
    }
  }
  
  // Update row count
  document.getElementById("rowCount").innerText = `${filteredData.length} data ditampilkan`;
  
  // Render tabel
  renderTable(filteredData);
}

// Render tabel
function renderTable(data) {
  const table = document.getElementById("sheetTable");
  const emptyState = document.getElementById("emptyState");
  
  if(!data || data.length === 0) {
    table.innerHTML = "";
    emptyState.classList.remove("hidden");
    return;
  }
  
  emptyState.classList.add("hidden");
  table.innerHTML = "";

  // Header - Ambil semua properti kecuali _originalData
  const sampleRow = data[0];
  const headers = Object.keys(sampleRow).filter(key => key !== '_originalData');
  
  // Pastikan nama dan kelas di depan
  const orderedHeaders = ['nama', 'kelas', ...headers.filter(h => h !== 'nama' && h !== 'kelas')];
  
  // Create header
  const thead = document.createElement("thead");
  thead.className = "bg-gray-50 sticky top-0 z-10";
  const trHead = document.createElement("tr");
  
  orderedHeaders.forEach(h => {
    const th = document.createElement("th");
    th.innerText = formatHeader(h);
    th.className = "px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200";
    trHead.appendChild(th);
  });
  
  thead.appendChild(trHead);
  table.appendChild(thead);

  // Body
  const tbody = document.createElement("tbody");
  tbody.className = "bg-white divide-y divide-gray-200";
  
  data.forEach((row, index) => {
    const tr = document.createElement("tr");
    tr.className = index % 2 === 0 ? "bg-white" : "bg-gray-50 hover:bg-gray-100";
    
    orderedHeaders.forEach(col => {
      const td = document.createElement("td");
      td.innerText = row[col] || "";
      
      // Styling berdasarkan nilai
      if (col === 'nama' || col === 'kelas') {
        td.className = "px-4 py-3 text-sm font-medium text-gray-900 whitespace-nowrap";
        if (col === 'nama') td.classList.add("font-semibold");
      } else {
        td.className = "px-4 py-3 text-sm text-gray-700 whitespace-nowrap";
        
        // Warna untuk status
        if (row[col] === "MASUK") {
          td.className = "px-4 py-3 text-sm text-gray-700 whitespace-nowrap bg-green-50";
        } else if (row[col] && row[col] !== "" && row[col] !== "MASUK") {
          td.className = "px-4 py-3 text-sm text-gray-700 whitespace-nowrap bg-yellow-50";
        }
      }
      
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
  
  table.appendChild(tbody);
}

// Format header
function formatHeader(header) {
  const map = {
    'nama': 'Nama Siswa',
    'kelas': 'Kelas',
    '1': 'Hari 1',
    '2': 'Hari 2',
    '3': 'Hari 3',
    '4': 'Hari 4',
    '5': 'Hari 5',
    '6': 'Hari 6',
    '7': 'Hari 7',
    '8': 'Hari 8',
    '9': 'Hari 9',
    '10': 'Hari 10',
    '11': 'Hari 11',
    '12': 'Hari 12',
    '13': 'Hari 13',
    '14': 'Hari 14',
    '15': 'Hari 15',
    '16': 'Hari 16',
    '17': 'Hari 17',
    '18': 'Hari 18',
    '19': 'Hari 19',
    '20': 'Hari 20',
    '21': 'Hari 21',
    '22': 'Hari 22',
    '23': 'Hari 23',
    '24': 'Hari 24',
    '25': 'Hari 25',
    '26': 'Hari 26',
    '27': 'Hari 27',
    '28': 'Hari 28',
    '29': 'Hari 29',
    '30': 'Hari 30',
    '31': 'Hari 31'
  };
  
  return map[header] || header;
}

// Reset form
function resetForm() {
  document.getElementById("value").value = "";
  document.getElementById("result").innerText = "";
  document.getElementById("col").value = "";
}

// Update cell
async function updateCell() {
  const siswaSelect = document.getElementById("siswaFilter");
  const selectedOption = siswaSelect.options[siswaSelect.selectedIndex];
  const _row = Number(siswaSelect.value);
  const col = Number(document.getElementById("col").value);
  const value = document.getElementById("value").value;
  const siswaName = selectedOption?.dataset.nama || "";

  if(!_row || !col || !value || !siswaName) {
    alert("Harap pilih siswa, tanggal, dan isi alasan terlebih dahulu!");
    return;
  }

  if(col < 3 || col > 33) {
    alert("Kolom harus antara 3-33!");
    return;
  }

  try {
    document.getElementById("result").innerText = "‚è≥ Mengirim data...";
    
    // Kirim data
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ _row, col, value })
    });

    const text = await res.text();
    console.log("Update response:", text);
    
    document.getElementById("result").innerText = "‚úÖ Data berhasil dikirim!";
    
    // Refresh data setelah 1 detik
    setTimeout(() => {
      loadData();
      if(currentKelas) {
        document.getElementById("kelasFilter").value = currentKelas;
        document.getElementById("kelasFilter").onchange();
      }
      if(currentSiswa) {
        const siswaSelect = document.getElementById("siswaFilter");
        for(let option of siswaSelect.options) {
          if(option.dataset.nama === currentSiswa) {
            siswaSelect.value = option.value;
            break;
          }
        }
      }
    }, 1000);
    
  } catch(e) {
    console.error("Update error:", e);
    document.getElementById("result").innerText = "‚ùå Gagal mengirim data";
  }
}
</script>
</body>
</html>
